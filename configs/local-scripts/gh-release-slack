#!/usr/bin/env bash
set -euo pipefail

if [[ $# -ne 1 ]]; then
  echo "Usage: gh-release-slack <pr-number>" >&2
  exit 1
fi

PR_NUMBER="$1"

if [[ ! "${PR_NUMBER}" =~ ^[0-9]+$ ]]; then
  echo "PR number must be numeric." >&2
  exit 1
fi

PR_DATA="$(gh pr view "${PR_NUMBER}" --json title,body --template '{{ .title }}{{"\n"}}{{ .body }}')"

if [[ -z "${PR_DATA}" ]]; then
  echo "Failed to read PR ${PR_NUMBER}." >&2
  exit 1
fi

TITLE="$(printf '%s\n' "${PR_DATA}" | sed -n '1p')"
RELEASE_NOTES="$(printf '%s\n' "${PR_DATA}" | sed '1d')"

if [[ ! "${TITLE}" =~ ^Release[[:space:]]+(.+)[[:space:]]+([^[:space:]]+)$ ]]; then
  echo "PR ${PR_NUMBER} title \"${TITLE}\" does not match \"Release <service> <version>\" format." >&2
  exit 1
fi

SERVICE="${BASH_REMATCH[1]}"
VERSION="${BASH_REMATCH[2]}"

trim() {
  local value="$1"
  value="${value#"${value%%[![:space:]]*}"}"
  value="${value%"${value##*[![:space:]]}"}"
  printf '%s' "$value"
}

SERVICE="$(trim "${SERVICE}")"

if [[ -z "${RELEASE_NOTES//[[:space:]]/}" ]]; then
  echo "PR ${PR_NUMBER} release notes are empty." >&2
  exit 1
fi

OUTPUT=$(printf 'Release %s `%s`\n\n%s' "${SERVICE}" "${VERSION}" "${RELEASE_NOTES}")

printf '%s\n' "${OUTPUT}"

if command -v pbcopy >/dev/null 2>&1; then
  if printf '%s' "${OUTPUT}" | pbcopy; then
    echo "Copied to clipboard." >&2
  else
    echo "Failed to copy to clipboard." >&2
  fi
else
  echo "pbcopy not available; clipboard copy skipped." >&2
fi
